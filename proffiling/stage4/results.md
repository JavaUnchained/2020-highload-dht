# Проифилирование нагрузки 4-го этапа
Нагрузочное тестирование с помощью wrk2 (код скрипта использовался из stage 1).
На данном этапе стреляем в 64 соединения и 4 потока.

## Анализ PUT-запросов и сравнение с реализацией прошлого этапа
#### Результаты wrk
Использовалась следующая команда терминала:
wrk -t4 -c64 -d20s -s proffiling/lua-scripts/put.lua -R40000 --latency http://127.0.0.1:8080

##### Рандеву хеширование
Результаты нагрузки:

    Running 20s test @ http://127.0.0.1:8080
    4 threads and 64 connections
    Thread calibration: mean lat.: 65.052ms, rate sampling interval: 366ms
    Thread calibration: mean lat.: 65.670ms, rate sampling interval: 363ms
    Thread calibration: mean lat.: 64.378ms, rate sampling interval: 360ms
    Thread calibration: mean lat.: 63.440ms, rate sampling interval: 357ms
    Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency     3.95ms    8.17ms  71.68ms   94.70%
    Req/Sec     8.76k   123.96     9.25k    91.67%
    Latency Distribution (HdrHistogram - Recorded Latency)
     50.000%    1.93ms
    75.000%    2.70ms
    90.000%    4.72ms
    99.000%   50.62ms
    99.900%   63.26ms
    99.990%   69.50ms
    99.999%   71.36ms
    100.000%   71.74ms

    Detailed Percentile spectrum:
       Value   Percentile   TotalCount 1/(1-Percentile)
       0.134     0.000000            1         1.00
       1.066     0.100000        34819         1.11
       1.328     0.200000        69485         1.25
       1.537     0.300000       104300         1.43
       1.731     0.400000       138896         1.67
       1.935     0.500000       173588         2.00
       2.051     0.550000       191159         2.22
       2.175     0.600000       208436         2.50
       2.319     0.650000       225812         2.86
       2.487     0.700000       243142         3.33
       2.703     0.750000       260377         4.00
       2.841     0.775000       269077         4.44
       3.013     0.800000       277811         5.00
       3.227     0.825000       286451         5.71
       3.509     0.850000       295103         6.67
       3.929     0.875000       303798         8.00
       4.251     0.887500       308132         8.89
       4.723     0.900000       312468        10.00
       5.559     0.912500       316797        11.43
       6.775     0.925000       321132        13.33
       8.599     0.937500       325482        16.00
      10.311     0.943750       327640        17.78
      14.063     0.950000       329811        20.00
      19.295     0.956250       331981        22.86
      24.943     0.962500       334150        26.67
      30.239     0.968750       336321        32.00
      32.511     0.971875       337409        35.56
      34.495     0.975000       338490        40.00
      36.991     0.978125       339576        45.71
      40.255     0.981250       340660        53.33
      45.375     0.984375       341756        64.00
      47.231     0.985938       342291        71.11
      48.735     0.987500       342832        80.00
      49.951     0.989062       343370        91.43
      51.135     0.990625       343925       106.67
      52.319     0.992188       344466       128.00
      52.863     0.992969       344728       142.22
      53.535     0.993750       345009       160.00
      54.143     0.994531       345279       182.86
      54.943     0.995313       345548       213.33
      55.967     0.996094       345811       256.00
      56.543     0.996484       345948       284.44
      57.407     0.996875       346088       320.00
      58.303     0.997266       346222       365.71
      59.039     0.997656       346356       426.67
      60.223     0.998047       346491       512.00
      60.927     0.998242       346560       568.89
      61.631     0.998437       346626       640.00
      62.239     0.998633       346698       731.43
      62.719     0.998828       346761       853.33
      63.327     0.999023       346829      1024.00
      63.711     0.999121       346867      1137.78
      63.967     0.999219       346897      1280.00
      64.287     0.999316       346931      1462.86
      64.799     0.999414       346967      1706.67
      65.279     0.999512       346998      2048.00
      65.599     0.999561       347015      2275.56
      65.919     0.999609       347034      2560.00
      66.495     0.999658       347051      2925.71
      66.879     0.999707       347067      3413.33
      67.583     0.999756       347083      4096.00
      67.775     0.999780       347091      4551.11
      68.031     0.999805       347101      5120.00
      68.671     0.999829       347108      5851.43
      68.927     0.999854       347117      6826.67
      69.311     0.999878       347127      8192.00
      69.439     0.999890       347130      9102.22
      69.503     0.999902       347136     10240.00
      69.631     0.999915       347139     11702.86
      69.759     0.999927       347144     13653.33
      69.887     0.999939       347146     16384.00
      69.951     0.999945       347148     18204.44
      70.207     0.999951       347152     20480.00
      70.335     0.999957       347153     23405.71
      70.463     0.999963       347155     27306.67
      70.655     0.999969       347158     32768.00
      70.655     0.999973       347158     36408.89
      70.719     0.999976       347160     40960.00
      70.719     0.999979       347160     46811.43
      70.783     0.999982       347161     54613.33
      71.231     0.999985       347162     65536.00
      71.295     0.999986       347163     72817.78
      71.295     0.999988       347163     81920.00
      71.359     0.999989       347164     93622.86
      71.359     0.999991       347164    109226.67
      71.551     0.999992       347166    131072.00
      71.551     0.999993       347166    145635.56
      71.551     0.999994       347166    163840.00
      71.551     0.999995       347166    187245.71
      71.551     0.999995       347166    218453.33
      71.551     0.999996       347166    262144.00
      71.551     0.999997       347166    291271.11
      71.551     0.999997       347166    327680.00
      71.743     0.999997       347167    374491.43
      71.743     1.000000       347167          inf
    #[Mean    =        3.948, StdDeviation   =        8.170]
    #[Max     =       71.680, Total count    =       347167]
    #[Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    698608 requests in 20.00s, 55.30MB read
    Requests/sec:  34930.63
    Transfer/sec:      2.77MB

##### По модулю
Результаты нагрузки:


При рассмотрении двух вариантов мы видим что средняя задержка практически одинакова, но зато
максимальная задержка, которая была зафиксирована в диапазоне от 99.900 до 99.999 вдове уменьшилась,
с 40 мс до 20 мс.

#### Результаты профилирования для cpu с помощью Async-profiler

![async-profiler put cpu](flamegraphs/async_put_cpu.svg)

Наша ассинхронная реализация в левом углу имеет 8 стеков NIOSelector-ов, котороые в предидущей
реализации были внизу каждого стека, каждый из воркеров при этом заниммает по 1.8% нашего процессора,
а у основания стека каждого потока мы имеем наши пронумерованные ворекры. При этом без ассинхронномтси
воркеры занимали у нас по 12% процессора на каждый поток, а воркеры 10%, при этом мы понимаем что,
раз селекторы заняты лишь на 2% то мы могли бы при наличии ресурсов и дальше увеличивать количество
соединений и потоков, особого простоя мы бы не достигили.

#### Результаты профилирования Allocation с помощью Async-profiler

![async-profiler put cpu](flamegraphs/async_put_alloc.svg)

По выделению памяти в случае ассинхронной реализации мы также имеем разделение. Память у нас выделяется
под каждый наш селектор 6.47% (на поток) и отдельно ворекры. HttpSession.sendResponse у нас ожидаем
находится в воркере и занимает по 1.79% на поток, а DAO.upsert занимает всего 0.88% на поток.
В случае с не асинхронной реализацией, мы выделиляли 1.2% на ответ и 1.32% на запрос в базу.

При этом в обоих случаях мы тратили достаточно много на выделение памяти под парсинг запроса.
Но в асинхронной реализации граф показывает что мы тратили на это меньше 1.61% вместо 6.4%.
 
#### Результаты профилирования Lock с помощью Async-profiler
 
  Асинхронный:
 ![async-profiler put cpu](flamegraphs/async_put_lock.svg)

В данном случае это самое главное отличие двух реализаций. На прошлом этапе у нас ничего нигде не 
блокировалось, а в асинхронной реализации уже показывает себя ArrayBlockingQueue. Как бы то нибыло,
все потоки одинаковых размеров, а значит мы не имеем доминирующих и голодающих потоков.
 
 
 ## Анализ GET-запросов и сравнение с реализацией прошлого этапа
 #### Результаты wrk
 Использовалась следующая команда терминала:
  wrk -t4 -c64 -d20s -s proffiling/lua-scripts/get.lua -R50000 --latency http://127.0.0.1:8080
 
 ##### Рандеву хеширование
 Результаты нагрузки:
    
    Running 20s test @ http://127.0.0.1:8080
    4 threads and 64 connections
    Thread calibration: mean lat.: 2.170ms, rate sampling interval: 10ms
    Thread calibration: mean lat.: 2.156ms, rate sampling interval: 10ms
    Thread calibration: mean lat.: 2.202ms, rate sampling interval: 10ms
    Thread calibration: mean lat.: 2.311ms, rate sampling interval: 10ms
       Thread Stats   Avg      Stdev     Max   +/- Stdev
     Latency     2.50ms    5.20ms  74.05ms   98.13%
     Req/Sec     9.23k     1.31k   16.56k    79.69%
    Latency Distribution (HdrHistogram - Recorded Latency)
    50.000%    1.71ms
    75.000%    2.46ms
    90.000%    3.30ms
    99.000%   35.52ms
    99.900%   60.45ms
    99.990%   70.40ms
    99.999%   73.15ms
    100.000%   74.11ms
 
    Detailed Percentile spectrum:
        Value   Percentile   TotalCount 1/(1-Percentile)
 
        0.106     0.000000            2         1.00
        0.832     0.100000        34849         1.11
        1.079     0.200000        69575         1.25
        1.287     0.300000       104255         1.43
        1.492     0.400000       138935         1.67
        1.714     0.500000       173645         2.00
        1.837     0.550000       191114         2.22
        1.969     0.600000       208395         2.50
        2.117     0.650000       225882         2.86
        2.275     0.700000       243062         3.33
        2.457     0.750000       260432         4.00
        2.559     0.775000       269188         4.44
        2.669     0.800000       277808         5.00
        2.795     0.825000       286586         5.71
        2.937     0.850000       295203         6.67
        3.099     0.875000       303866         8.00
        3.193     0.887500       308208         8.89
        3.301     0.900000       312562        10.00
        3.417     0.912500       316846        11.43
        3.549     0.925000       321188        13.33
        3.711     0.937500       325562        16.00
        3.809     0.943750       327708        17.78
        3.917     0.950000       329869        20.00
        4.051     0.956250       332035        22.86
        4.215     0.962500       334223        26.67
        4.435     0.968750       336403        32.00
        4.583     0.971875       337464        35.56
        4.803     0.975000       338557        40.00
        5.223     0.978125       339636        45.71
        7.591     0.981250       340717        53.33
       16.479     0.984375       341800        64.00
       22.143     0.985938       342343        71.11
       27.551     0.987500       342888        80.00
       33.119     0.989062       343428        91.43
       36.511     0.990625       343976       106.67
       39.071     0.992188       344513       128.00
       41.599     0.992969       344786       142.22
       44.607     0.993750       345056       160.00
       47.135     0.994531       345328       182.86
       49.087     0.995313       345599       213.33
       51.167     0.996094       345870       256.00
       52.287     0.996484       346005       284.44
       53.599     0.996875       346141       320.00
       54.943     0.997266       346276       365.71
       56.447     0.997656       346414       426.67
       57.791     0.998047       346548       512.00
       58.367     0.998242       346619       568.89
       58.911     0.998437       346684       640.00
       59.423     0.998633       346758       731.43
       59.999     0.998828       346820       853.33
       60.511     0.999023       346890      1024.00
       60.799     0.999121       346923      1137.78
       61.247     0.999219       346954      1280.00
       61.759     0.999316       346988      1462.86
       62.399     0.999414       347024      1706.67
       63.647     0.999512       347056      2048.00
       64.415     0.999561       347073      2275.56
       65.183     0.999609       347090      2560.00
       66.111     0.999658       347107      2925.71
       67.327     0.999707       347124      3413.33
       68.223     0.999756       347141      4096.00
       68.607     0.999780       347150      4551.11
       68.991     0.999805       347159      5120.00
       69.375     0.999829       347166      5851.43
       69.759     0.999854       347176      6826.67
       70.079     0.999878       347183      8192.00
       70.335     0.999890       347187      9102.22
       70.463     0.999902       347192     10240.00
       70.655     0.999915       347198     11702.86
       70.783     0.999927       347201     13653.33
       70.847     0.999939       347205     16384.00
       71.039     0.999945       347207     18204.44
       71.103     0.999951       347209     20480.00
       71.167     0.999957       347211     23405.71
       71.295     0.999963       347213     27306.67
       71.551     0.999969       347215     32768.00
       71.615     0.999973       347216     36408.89
       71.999     0.999976       347218     40960.00
       71.999     0.999979       347218     46811.43
       72.127     0.999982       347219     54613.33
       72.383     0.999985       347220     65536.00
       72.703     0.999986       347221     72817.78
       72.703     0.999988       347221     81920.00
       73.151     0.999989       347222     93622.86
       73.151     0.999991       347222    109226.67
       73.599     0.999992       347223    131072.00
       73.599     0.999993       347223    145635.56
       73.599     0.999994       347223    163840.00
       73.855     0.999995       347224    187245.71
       73.855     0.999995       347224    218453.33
       73.855     0.999996       347224    262144.00
       73.855     0.999997       347224    291271.11
       73.855     0.999997       347224    327680.00
       74.111     0.999997       347225    374491.43
       74.111     1.000000       347225          inf
    #[Mean    =        2.503, StdDeviation   =        5.198]
    #[Max     =       74.048, Total count    =       347225]
    #[Buckets =           27, SubBuckets     =         2048]
    ----------------------------------------------------------
    698670 requests in 20.00s, 59.51MB read
    Requests/sec:  34930.90
     Transfer/sec:      2.98MB

 ##### По модулю
 Результаты нагрузки:
 
В случае get, мы имеем примерно одинаковую среднюю задержку, но в случае с асинхронной реализацеией
её максимальные значения увеличились с 18-20 мс до 21-29 для 99.900-100%. Это всё равно не критичная,
задерка, особенно учитывая что для LSM хранилищ put является наиболее важной операцией. 
  
 #### Результаты профилирования для cpu с помощью Async-profiler
   
 Асинхронный:
 ![async-profiler put cpu](flamegraphs/async_get_cpu.svg)

 Аналогично put-запросам, в асинхронной реализации у нас появились отдельные потоки селекторов, в случае
 с get запросом они тратят 3.2% на поток. 3.6% на поток уходит на операцию get (DAOImpl) при асинхронной реализации
 и 7.19% при обычной. На отправку ответа в случае в асинхронной реализации тратится 4.11% на поток, а в
 обычной 3.6% (HttpSession.sendResponse).
 
 #### Результаты профилирования Allocation с помощью Async-profiler
 
  ![async-profiler put cpu](flamegraphs/async_get_alloc.svg)
 
 По выделению памяти в случае ассинхронной реализации мы также имеем разделение. Память у нас выделяется
 под каждый наш селектор 6.4% (на поток) и отдельно ворекры 6.22 (в не асинхронной реализации орба стека
 объединены и занимают 12.3%. HttpSession.sendResponse занимает по 1.76% на поток, 
 а DAO.get занимает 1.66% на поток.
 В случае с не асинхронной реализацией, мы выделиляли 1.7% на ответ и 1.5% на запрос в базу.
 
 При этом в обоих случаях мы тратили достаточно много на выделение памяти под парсинг запроса.
 Но в асинхронной реализации граф показывает что мы тратили на это меньше 1.61% вместо 6.4%.

#### Результаты профилирования Lock с помощью Async-profiler

  ![async-profiler put cpu](flamegraphs/async_get_lock.svg)

### Выводы
